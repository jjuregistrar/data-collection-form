<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enhanced Survey Form</title>
  <style>
    :root {
      color-scheme: light dark;
    }
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      margin: 2rem; 
      line-height: 1.5;
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .form-container {
      border: 2px solid #4CAF50;
      border-radius: 10px;
      padding: 2rem;
      margin-bottom: 2rem;
      background-color: #f9f9f9;
    }
    
    .closed-message {
      border: 2px solid #f44336;
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      background-color: #ffebee;
      display: none;
    }
    
    form { 
      display: grid; 
      gap: 1.2rem;
    }
    
    .form-group { 
      display: grid; 
      gap: 0.5rem;
    }
    
    label { 
      font-weight: 600; 
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .required::after {
      content: " *";
      color: #f44336;
    }
    
    input, select, textarea, button { 
      font-size: 1rem; 
      padding: 0.75rem; 
      width: 100%; 
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: 2px solid #4CAF50;
      border-color: #4CAF50;
    }
    
    input.error, select.error, textarea.error {
      border-color: #f44336;
      background-color: #ffebee;
    }
    
    .error-message {
      color: #f44336;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }
    
    .character-count {
      font-size: 0.875rem;
      color: #666;
      text-align: right;
      margin-top: 0.25rem;
    }
    
    .character-count.warning {
      color: #ff9800;
    }
    
    .character-count.error {
      color: #f44336;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      cursor: pointer;
      width: auto;
      margin: 1rem 0;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    .success { 
      color: #4CAF50; 
      font-weight: bold;
    }
    
    .error { 
      color: #f44336; 
      font-weight: bold;
    }
    
    .muted { 
      opacity: 0.85; 
      font-size: 0.9rem;
    }
    
    .admin-panel {
      margin-top: 2rem;
      padding: 1rem;
      background-color: #e8f5e9;
      border-radius: 8px;
      border: 1px solid #4CAF50;
    }
    
    .admin-panel h3 {
      margin-top: 0;
      color: #2e7d32;
    }
    
    .admin-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .admin-btn {
      padding: 0.5rem 1rem;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .admin-btn.close-btn {
      background-color: #f44336;
    }
    
    .admin-btn.open-btn {
      background-color: #4CAF50;
    }
    
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #1e1e1e;
        color: #ffffff;
      }
      
      .form-container {
        background-color: #2d2d2d;
        border-color: #4CAF50;
      }
      
      .closed-message {
        background-color: #3c1f1f;
        border-color: #f44336;
      }
      
      input, select, textarea {
        background-color: #3c3c3c;
        color: white;
        border-color: #555;
      }
      
      .admin-panel {
        background-color: #1c331d;
      }
    }
  </style>
</head>
<body>
  <h1>Enhanced Survey Form</h1>
  
  <!-- Form Status Message (Open/Closed) -->
  <div id="statusMessage" class="muted"></div>
  
  <!-- Closed Submission Message -->
  <div id="closedMessage" class="closed-message">
    <h2>‚ö†Ô∏è Submissions Closed</h2>
    <p>We are not currently accepting new submissions. Please check back later.</p>
  </div>
  
  <!-- Main Form Container -->
  <div id="formContainer" class="form-container">
    <form id="surveyForm" novalidate>
      <!-- Personal Information -->
      <div class="form-group">
        <label for="name" class="required">Full Name</label>
        <input type="text" id="name" name="name" 
               placeholder="Enter your full name"
               maxlength="100"
               required>
        <div class="error-message" id="nameError">Name is required (2-100 characters)</div>
      </div>
      
      <div class="form-group">
        <label for="email" class="required">Email Address</label>
        <input type="email" id="email" name="email" 
               placeholder="your.email@example.com"
               required>
        <div class="error-message" id="emailError">Valid email address is required</div>
      </div>
      
      <div class="form-group">
        <label for="phone">Phone Number (Optional)</label>
        <input type="tel" id="phone" name="phone" 
               placeholder="+1 (123) 456-7890"
               pattern="^[\+]?[0-9\s\-\(\)]+$"
               maxlength="20">
        <div class="error-message" id="phoneError">Please enter a valid phone number</div>
      </div>
      
      <!-- Age Group Dropdown -->
      <div class="form-group">
        <label for="age" class="required">Age Group</label>
        <select id="age" name="age" required>
          <option value="">Select your age group</option>
          <option value="under18">Under 18</option>
          <option value="18-25">18-25</option>
          <option value="26-35">26-35</option>
          <option value="36-50">36-50</option>
          <option value="51-65">51-65</option>
          <option value="over65">Over 65</option>
        </select>
        <div class="error-message" id="ageError">Please select your age group</div>
      </div>
      
      <!-- Country Selection -->
      <div class="form-group">
        <label for="country" class="required">Country</label>
        <select id="country" name="country" required>
          <option value="">Select your country</option>
          <option value="US">United States</option>
          <option value="UK">United Kingdom</option>
          <option value="CA">Canada</option>
          <option value="AU">Australia</option>
          <option value="IN">India</option>
          <option value="other">Other</option>
        </select>
        <div class="error-message" id="countryError">Please select your country</div>
      </div>
      
      <!-- Product Rating -->
      <div class="form-group">
        <label for="rating" class="required">How would you rate our service?</label>
        <select id="rating" name="rating" required>
          <option value="">Select a rating</option>
          <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê - Excellent</option>
          <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê - Very Good</option>
          <option value="3">‚≠ê‚≠ê‚≠ê - Good</option>
          <option value="2">‚≠ê‚≠ê - Fair</option>
          <option value="1">‚≠ê - Poor</option>
        </select>
        <div class="error-message" id="ratingError">Please select a rating</div>
      </div>
      
      <!-- Subscription Type -->
      <div class="form-group">
        <label for="subscription" class="required">Subscription Type</label>
        <select id="subscription" name="subscription" required>
          <option value="">Select subscription type</option>
          <option value="free">Free</option>
          <option value="basic">Basic ($9.99/month)</option>
          <option value="premium">Premium ($19.99/month)</option>
          <option value="enterprise">Enterprise (Custom)</option>
        </select>
        <div class="error-message" id="subscriptionError">Please select subscription type</div>
      </div>
      
      <!-- Feedback with Character Limit -->
      <div class="form-group">
        <label for="feedback" class="required">Your Feedback</label>
        <textarea id="feedback" name="feedback" 
                  rows="5" 
                  placeholder="Please share your detailed feedback here..."
                  maxlength="500"
                  required></textarea>
        <div class="character-count" id="feedbackCount">0/500 characters</div>
        <div class="error-message" id="feedbackError">Feedback is required (10-500 characters)</div>
      </div>
      
      <!-- How Did You Hear About Us? -->
      <div class="form-group">
        <label for="source" class="required">How did you hear about us?</label>
        <select id="source" name="source" required>
          <option value="">Select an option</option>
          <option value="search">Search Engine (Google, Bing, etc.)</option>
          <option value="social">Social Media (Facebook, Twitter, etc.)</option>
          <option value="friend">Friend/Word of Mouth</option>
          <option value="ad">Advertisement</option>
          <option value="email">Email Newsletter</option>
          <option value="other">Other</option>
        </select>
        <div class="error-message" id="sourceError">Please tell us how you heard about us</div>
      </div>
      
      <!-- Terms and Conditions -->
      <div class="form-group">
        <label style="display: flex; align-items: flex-start; gap: 0.5rem;">
          <input type="checkbox" id="terms" name="terms" required>
          <span>I agree to the <a href="#" target="_blank">Terms and Conditions</a> and <a href="#" target="_blank">Privacy Policy</a> *</span>
        </label>
        <div class="error-message" id="termsError">You must agree to the terms to continue</div>
      </div>
      
      <!-- Submit Button -->
      <button type="submit" id="submitBtn">Submit Survey</button>
      <p id="msg" role="status" aria-live="polite"></p>
    </form>
  </div>
  
  <!-- Admin Control Panel (Hidden by default, show with ?admin=true) -->
  <div id="adminPanel" class="admin-panel" style="display: none;">
    <h3>üìã Admin Controls</h3>
    <div class="admin-controls">
      <button class="admin-btn open-btn" onclick="setFormStatus(true)">Open Submissions</button>
      <button class="admin-btn close-btn" onclick="setFormStatus(false)">Close Submissions</button>
      <button class="admin-btn" onclick="clearForm()">Clear Form</button>
      <button class="admin-btn" onclick="testSubmission()">Test Submission</button>
      <button class="admin-btn" onclick="viewAllSubmissions()">View All Submissions</button>
    </div>
    <div id="adminMessage" class="muted"></div>
  </div>

<script>
  // IMPORTANT: Replace with your Apps Script Web App URL
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbx-xh1Eu3kWPVjYNz92IxX_zZb34cVQXKYap2PJ62Gf4n-rpnmPHqiXa8rNNVbKwMkQHQ/exec';
  
  // Configuration
  const CONFIG = {
    formOpen: true,
    maxFeedbackChars: 500,
    minFeedbackChars: 10,
    maxNameChars: 100,
    phonePattern: /^[\+]?[0-9\s\-\(\)]+$/,
    emailPattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
    requiredFields: ['name', 'email', 'age', 'country', 'rating', 'subscription', 'feedback', 'source', 'terms']
  };

  // DOM Elements
  const form = document.getElementById('surveyForm');
  const msg = document.getElementById('msg');
  const submitBtn = document.getElementById('submitBtn');

  // Debug logging function
  function debugLog(message, data = null) {
    console.log(`[DEBUG] ${message}`, data || '');
  }

  // Initialize form
  window.addEventListener('DOMContentLoaded', () => {
    debugLog('Form initialized');
    setupEventListeners();
    testEndpointConnection();
  });

  // Setup event listeners
  function setupEventListeners() {
    form.addEventListener('submit', handleSubmit);
    
    // Character counter for feedback
    const feedbackTextarea = document.getElementById('feedback');
    const feedbackCount = document.getElementById('feedbackCount');
    
    if (feedbackTextarea && feedbackCount) {
      feedbackTextarea.addEventListener('input', function() {
        const length = this.value.length;
        feedbackCount.textContent = `${length}/500 characters`;
      });
    }
  }

  // Test endpoint connection
  async function testEndpointConnection() {
    debugLog('Testing endpoint connection...');
    
    try {
      // First try with GET to see if endpoint is reachable
      const response = await fetch(ENDPOINT, {
        method: 'GET',
        mode: 'no-cors' // Use no-cors for initial test
      });
      
      debugLog('GET request sent to endpoint');
      
      // Also try a direct browser test
      setTimeout(() => {
        const testLink = document.createElement('a');
        testLink.href = ENDPOINT;
        testLink.target = '_blank';
        testLink.textContent = 'Test endpoint in new tab';
        testLink.style.display = 'block';
        testLink.style.margin = '10px 0';
        testLink.style.padding = '10px';
        testLink.style.backgroundColor = '#f0f0f0';
        testLink.style.textDecoration = 'none';
        
        const container = document.querySelector('.form-container');
        if (container) {
          container.appendChild(testLink);
        }
      }, 1000);
      
    } catch (error) {
      debugLog('Endpoint test failed:', error);
    }
  }

  // Set status message
  function setStatus(text, cls = '') {
    msg.textContent = text;
    msg.className = cls;
    debugLog(`Status: ${text}`);
  }

  // Validate form
  function validateForm() {
    let isValid = true;
    
    CONFIG.requiredFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        const value = field.type === 'checkbox' ? field.checked : field.value.trim();
        const isRequired = CONFIG.requiredFields.includes(fieldId);
        
        if (isRequired && !value) {
          isValid = false;
          const errorElement = document.getElementById(`${fieldId}Error`);
          if (errorElement) {
            errorElement.style.display = 'block';
          }
          field.classList.add('error');
        } else {
          field.classList.remove('error');
          const errorElement = document.getElementById(`${fieldId}Error`);
          if (errorElement) {
            errorElement.style.display = 'none';
          }
        }
      }
    });
    
    return isValid;
  }

  // Handle form submission with detailed debugging
  async function handleSubmit(e) {
    e.preventDefault();
    
    debugLog('Form submission started');
    setStatus('Submitting...', 'muted');
    submitBtn.disabled = true;
    
    // Validate form
    if (!validateForm()) {
      setStatus('Please fix the errors above.', 'error');
      submitBtn.disabled = false;
      return;
    }
    
    try {
      // Prepare form data
      const formData = {
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        age: document.getElementById('age').value,
        country: document.getElementById('country').value,
        rating: document.getElementById('rating').value,
        subscription: document.getElementById('subscription').value,
        feedback: document.getElementById('feedback').value.trim(),
        source: document.getElementById('source').value,
        terms: document.getElementById('terms').checked ? 'Agreed' : 'Not agreed'
      };
      
      debugLog('Form data prepared:', formData);
      
      // Try different methods to see what works
      let response;
      let result;
      
      // METHOD 1: Try with JSON (most common)
      debugLog('Trying METHOD 1: JSON POST');
      try {
        response = await fetch(ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });
        
        debugLog('Response received:', {
          status: response.status,
          statusText: response.statusText,
          headers: Object.fromEntries(response.headers.entries())
        });
        
        result = await response.json();
        debugLog('Response JSON:', result);
        
      } catch (jsonError) {
        debugLog('JSON method failed:', jsonError);
        
        // METHOD 2: Try with FormData (URL encoded)
        debugLog('Trying METHOD 2: FormData POST');
        const formDataEncoded = new URLSearchParams();
        Object.keys(formData).forEach(key => {
          formDataEncoded.append(key, formData[key]);
        });
        
        response = await fetch(ENDPOINT, {
          method: 'POST',
          body: formDataEncoded
        });
        
        result = await response.json();
        debugLog('FormData response:', result);
      }
      
      if (result && result.ok) {
        setStatus('‚úÖ Thank you! Your response has been saved.', 'success');
        form.reset();
        
        // Show submission ID if available
        if (result.submissionId) {
          setTimeout(() => {
            setStatus(`‚úÖ Thank you! Your response has been saved. Reference ID: ${result.submissionId}`, 'success');
          }, 1000);
        }
        
      } else {
        setStatus(`‚ùå Error: ${result ? result.error : 'Unknown error'}`, 'error');
        debugLog('Server returned error:', result);
      }
      
    } catch (err) {
      debugLog('Submission error details:', {
        name: err.name,
        message: err.message,
        stack: err.stack
      });
      
      // Show more specific error messages
      if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
        setStatus('‚ùå Cannot connect to server. Please check:', 'error');
        
        // Create troubleshooting tips
        setTimeout(() => {
          const tips = document.createElement('div');
          tips.style.marginTop = '10px';
          tips.style.padding = '10px';
          tips.style.backgroundColor = '#fff3cd';
          tips.style.border = '1px solid #ffeaa7';
          tips.style.borderRadius = '4px';
          tips.innerHTML = `
            <strong>Troubleshooting Tips:</strong>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li>1. Check your internet connection</li>
              <li>2. Make sure the endpoint URL is correct</li>
              <li>3. Try opening the endpoint in a new tab: <a href="${ENDPOINT}" target="_blank">Test Link</a></li>
              <li>4. Check if your Apps Script is deployed</li>
              <li>5. Verify "Who has access" is set to "Anyone"</li>
            </ul>
          `;
          msg.parentNode.appendChild(tips);
        }, 500);
        
      } else if (err.name === 'SyntaxError') {
        setStatus('‚ùå Server returned invalid response. Check Apps Script logs.', 'error');
      } else {
        setStatus(`‚ùå Error: ${err.message}`, 'error');
      }
      
    } finally {
      submitBtn.disabled = false;
    }
  }

  // Add a direct test button for debugging
  setTimeout(() => {
    const debugDiv = document.createElement('div');
    debugDiv.style.margin = '20px 0';
    debugDiv.style.padding = '15px';
    debugDiv.style.backgroundColor = '#e8f4f8';
    debugDiv.style.border = '1px solid #b6e0f7';
    debugDiv.style.borderRadius = '4px';
    
    debugDiv.innerHTML = `
      <h4 style="margin-top: 0;">Debug Tools</h4>
      <button onclick="runDebugTest()" style="padding: 8px 12px; margin-right: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Test Endpoint
      </button>
      <button onclick="showFormData()" style="padding: 8px 12px; margin-right: 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Show Form Data
      </button>
      <button onclick="clearForm()" style="padding: 8px 12px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Clear Form
      </button>
      <div id="debugOutput" style="margin-top: 10px; font-family: monospace; font-size: 12px;"></div>
    `;
    
    form.parentNode.insertBefore(debugDiv, form.nextSibling);
  }, 2000);

  // Debug functions
  async function runDebugTest() {
    const debugOutput = document.getElementById('debugOutput');
    debugOutput.innerHTML = 'Testing endpoint...';
    
    try {
      const response = await fetch(ENDPOINT + '?test=1');
      const text = await response.text();
      debugOutput.innerHTML = `<pre>${JSON.stringify({status: response.status, body: text}, null, 2)}</pre>`;
    } catch (error) {
      debugOutput.innerHTML = `<pre style="color: red;">Error: ${error.message}</pre>`;
    }
  }
  
  function showFormData() {
    const debugOutput = document.getElementById('debugOutput');
    const formData = {
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      age: document.getElementById('age').value,
      country: document.getElementById('country').value,
      rating: document.getElementById('rating').value,
      subscription: document.getElementById('subscription').value,
      feedback: document.getElementById('feedback').value,
      source: document.getElementById('source').value,
      terms: document.getElementById('terms').checked
    };
    debugOutput.innerHTML = `<pre>${JSON.stringify(formData, null, 2)}</pre>`;
  }
  
  function clearForm() {
    form.reset();
    setStatus('Form cleared', 'muted');
  }
</script>
</body>
</html>
